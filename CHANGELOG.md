# Changelog
All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## [Planning]

### 實體
用來代表遠端客戶端 / 遠端伺服器 / 獨立系統等  
實體上可以掛載模組, 用來分離系統的各個細節功能, 降低複雜度  
擁有模組管理器, 管理實體上的模組  
擁有事件管理器, 會執行獨立的事件循環, 讓模組可以訂閱/發布事件  
擁有封包管理器, 當會話接收到封包時, 會向所屬實體投遞封包事件(通過事件管理器), 封包管理器會收到事件並接手處理; 模組可以對封包管理器註冊處理函式  
擁有會話物件, 用於把連接與實體關聯起來; 如果實體沒有會話物件, 表示用於代表遊戲中的獨立系統  
* 實體編號: 由外部決定
* 實體名稱
* 模組管理
* 事件管理
* 封包管理
* 會話物件

### 實體管理器
用來管理實體  

### 標籤管理器
用來幫實體分類, 並且可以標籤來搜尋實體列表  
實體必須經由增加/刪除標籤的方式來改變在標籤管理器中的關聯  

### 模組
用來代表功能的實作, 實務上也可以由一個模組提供核心資料, 其他模組負責與此資料有關的操作(但是要注意多執行緒問題)  
模組可以反向取得所屬實體, 這樣就可以操作事件 / 封包 / 會話相關功能  
模組應當可用程式碼產生工具產生, 這種狀況下, 需要用擴展方式來避免把使用者的程式碼覆蓋掉  
* 模組編號: 由外部決定
* 模組名稱
* 宿主實體
* 擴展資料

### 模組事件
模組有以下幾個系統事件, 當模組擁有事件相關的函式時, 會在事件發生時去執行該函式  
* awake: 會在實體啟動或是模組加入實體時執行, 只會執行一次
* start: 會在awake執行後執行, 只會執行一次
* dispose: 會在移除模組時執行, 只會執行一次
* update: 會每秒執行

### 模組管理器
用來管理模組, 但是管理器中儲存的是模組介面而非模組  

### 事件管理器
用來執行系統事件或是使用者自訂事件, 這些事件會在獨立的事件循環中執行  

### 封包管理器
用來處理封包事件(來自事件循環), 以及管理封包處理函式相關  

### 網路管理器
由兩部分組成: 接聽管理器, 連接管理器  
至於產生出來的會話物件管理, 就不在此管理器範圍內了  
* 接聽管理器  
  新增接聽時, 會建立接聽物件, 並且等待接聽完成產生會話物件  
  當產生會話物件時, 需要把產生的會話物件傳遞給提前設定好的新增會話處理函式  
  由於接聽是持續性的, 所以還得有一系列的操作功能來控制已產生的接聽物件  
* 連接管理器  
  新增連接時, 會建立連接物件, 並且等待連接完成產生會話物件  
  當產生會話物件時, 需要把產生的會話物件傳遞給提前設定好的新增會話處理函式  
  當連接完成後, 連接物件就該自己移除了, 所以不會有連接系列操作功能  

### 網路機制
負責接聽 / 連接到遠端, 並產生會話物件來進行封包發送與接收處理  
* 網路介面  
  定義接聽 / 連接 / 會話 / 管線介面  
* 管線機制  
  管線可以設定在會話物件中  
    * 傳送管線: 封包資料如何變成位元陣列
    * 接收管線: 位元陣列如何變成封包資料
    * 管線通常包括以下流程
        * 傳送: 序列化 > 加密 > MD5填寫
        * 接收: MD5檢驗 > 解密 > 反序列化
* tcp組件
    * 接聽物件: 接聽完成後產生會話物件
    * 連接物件: 連接完成後產生會話物件
    * 會話物件: 網路主要的功能會在此處
    * 客戶端組件(cs): 專門給unity客戶端使用的組件
        * 也得做管線要做的事喔QQ
* udp組件
* websocket組件
* https組件

### 加解密機制
負責資料加密與解密  
AES / DES  
https://willh.gitbook.io/build-web-application-with-golang-zhtw/09.0/09.6  
MD5  
https://blog.csdn.net/skh2015java/article/details/53468434  

### 日誌機制
提供接口讓內部的日誌可以輸出到使用者希望的組件上  
* 日誌介面
* zap日誌

### 設定檔機制
看看能不能把多個設定檔讀進一個設定檔管理器, 讓各系統(包括使用者自訂的系統)可以使用  
看看能不能做個介面, 然後實作可以用不同的函式庫實作  

### 如何組織網路
難點可能在設定檔如何安排, 尤其是如果只想用單一設定檔案來描述整個網路與伺服器該怎麼做  
前次的做法是為伺服器定義群名稱, 然後可能會先安排群內互聯(不確定), 然後再安排群與群之間是否有連接關係  
由於mizugo的連接會有連接與接聽方, 因此群與群之間的連接是否也該定義好誰為連接方, 誰為接聽方  

### 資料庫機制
如何初始化資料庫組件, 操作資料庫  
TODO: 資料庫機制還可以再細分  
* redis
* mongo
* mysql
* 資料庫機制自動代碼產生的範圍

### 單元測試工具
規劃中  

### 流程測試框架
規劃中  

### 伺服器程式碼產生
等基礎的項目完成後才有辦法開始規劃吧  
* 有哪些程式碼要產生
* 有哪些設定檔要產生
* 要產生在那些目錄(以及目錄結構)
* 要怎麼避免覆蓋掉使用者寫的程式碼
* 產生出的程式碼仍然要保持易讀性

## [Roadmap]
* 實體-模組機制
* 事件管理器
* 網路機制
* 管線機制
* 加解密+MD5
* unity客戶端
* 網路驗證測試
    * 測試連線是否成功
    * 測試隨機內容封包是否成功
    * 大概用單元測試來做
* 網路長連線測試
    * 使用對外伺服器
    * 使用捷運
    * 測試 連線 > 封包 > 封包 > ... 這樣的流程; 如果斷線, 就自動重連
    * 記錄封包平均時間
    * 記錄封包次數
    * 記錄連線到斷線的平均時間
    * 記錄斷線次數
* 網路短連線測試
    * 使用對外伺服器
    * 使用捷運
    * 測試 連線 > 封包 > 斷線 > 連線 > 封包 ... 這樣的流程
    * 記錄流程平均時間
    * 記錄流程次數
* 網路連線效能測試
    * 測試10000個連線
    * 記錄每秒完成多少連線
* 網路封包效能測試
    * 測試10000個連線
    * 測試 連線 > 封包 > 封包 > ... 這樣的流程; 如果斷線, 就自動重連
    * 記錄每秒完成多少封包
* 網路管理器
* 封包管理器
* (opt)多合一封包機制
* (opt)多合一封包測試(容量測試, 效率測試)
* 標籤管理器
* 設定檔機制
* 資料庫機制
* 日誌機制
* !遊戲業務開始!
* 流程測試框架
* 專案結構產生工具
* 資料庫結構產生工具
